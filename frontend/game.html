<!DOCTYPE html>
<html>
<head>
<title>Browsergame</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AD09PRo+Pj4MAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+Pj4MPj49Gv///wAAAAAAMDAwVS0tLc4rKyv+LCws7jU1NSoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0NDQqLCws7isrK/4tLS3OMTExVCsrK/AqKir/Kysr/ysrK/8uLi6qAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALi4uqisrK/8rKyv/Kioq/ywsLPAsLCzjKioq/zIyMv9UVFT/NTU1/DQzMy8tLS0KLS0tCi0tLQotLS0KMzMzLzk5OfxQUFD/LS0t/ysqKv8sLCzjLS0tni4uLv9PT0//8fHx/1VVVf8uLi79Ly8v/DQ0NPw0NDT8Ly8v/DAwMP1vb2///////z8/P/8tLS3/Li4tnjAwMFdtbW3/+fn5/7i4uP/7+/v/dHR0/39/f//9/f3//Pz8/4KCgv+dnZ3//////6mpqf//////U1NT/zAvL1dAQEAUQ0ND+3Fxcf/9/f3/c3Nz/0VFRf9IR0z/Y1iI/1iHaf9ITkr/TU1N/5WVlf//////dnZ2/zw8PPs9PT0U////AC0tLcc8PDz/hISE/0BAQP8rKir/Kyor/ysqLv8qLiv/Kisr/ysqKv9MTEz/oqKi/zIyMv8tLS3H////AAAAAAA0MzNKQEBA/z09Pf89PT3/LS0t3iwsLNssLCzbLCws2ywsLNsvLy/jPT09/z09Pf8+Pj76MzMzRQAAAAAAAAAA////AI+PjzyUlJRDkJCQPnl5eQIAAAAAAAAAAAAAAAAAAAAAeHh4BpOTkkGUlJRDjo6ONAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//8AAP//AAD//wAAj/EAAAfgAAAH4AAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAQAAg8MAAP//AAD//wAA//8AAA==" rel="icon" type="image/x-icon">

<link rel="stylesheet" type="text/css" href="game.css">

</head>

<div id="canvas"></div>

<div id="inventory">
    <h3 style="text-align: center;">Inventory</h3>
    <img class="picleft" src="/img/key1.png" onclick="javascript:functionone()">   
    <img class="picright"><br>
    <span class="spanleft">hi</span>
    <span class="spanright"></span>
    <br><br>
    <img class="picleft">
    <img class="picright"><br>
    <span class="spanleft"></span>
    <span class="spanright"></span>
    <br><br>
    <img class="picleft">
    <img class="picright"><br>
    <span class="spanleft"></span>
    <span class="spanright"></span>
    <br><br>
    <img class="picleft">
    <img class="picright"><br>
    <span class="spanleft"></span>
    <span class="spanright"></span>
    <br><br>
    <img class="picleft">
    <img class="picright"><br>
    <span class="spanleft"></span>
    <span class="spanright"></span>
    <br><br><br><br>
<div id="help">
    <h3 style="text-align: center;">Help</h3>
    <span class="left">look</span>
    <span class="right">north/n</span><br><br>
    <span class="left">pickup</span>
    <span class="right">south/s</span><br><br>
    <span class="left">use</span>
    <span class="right">east/e</span><br><br>
    <span class="left">talk</span>
    <span class="right">west/w</span>
</div>
</div>

<div id="input">
<h3 style="color: white;">Input</h3>
<button class="button" id="exit"><a href="/index.html" onclick="exitGame()">Exit</a></button>
<button class="button" id="won"><a href="/index.html" onclick="wonGame()">Won</a></button>
<div class="chat-container" id="chatWindow">
</div>
<div class="send-container" id="send-container">
    <form action="javascript:sendMessage(chatInput)">
        <input type="text" name="chatInput" id="chatInput" style="width: 220px; font-size:20px" autocomplete="off">
        <input class="button" type="submit" value="send" style="font-size:20px; width: fit-content">
    </form>
</div>
<p id="invalidInput" hidden>Not a valid input!</p>
<p id="coordinates">X = <span id="X"></span>  Y = <span id="Y"></span></p>
</div>
<img class="picleft" src="/img/Abandoned_Map.png"> 

<script>

    username = sessionStorage.getItem("player") || "guest";
    var x = 3, y = 3;
    document.getElementById("X").innerHTML = x;
    document.getElementById("Y").innerHTML = y;
    var container = document.getElementById('canvas');
    initCanvas(container);

    function clamp(number, min, max) {
        return Math.max(min, Math.min(number, max));
    }

    function sendMessage(chatInput) {
        let input = chatInput.value.toLowerCase();
        if (chatInput.value.trim().length > 0) {
            if (chatInput.value.startsWith("/")) {
                let msg = chatInput.value;
                var chatWindow = document.getElementById("chatWindow");
                chatWindow.innerHTML = "<p><b>" +
                    "<i> " + username + ": </i></b>" +
                    msg + "</p>" + chatWindow.innerHTML;
            }
            else if (input == "north" || input == "n") {
                y = clamp(y-1, 1, 6);
                document.getElementById("Y").innerHTML = y;
                drawPlayerLocation();
                checkCellPath();
                updatedb(input);
            } 
            else if (input == "south" || input == "s") {
                y = clamp(y+1, 1, 6);
                document.getElementById("Y").innerHTML = y;
                drawPlayerLocation();
                updatedb(input);
            }
            else if (input == "east" || input == "e") {
                x = clamp(x+1, 1, 6);
                document.getElementById("X").innerHTML = x;
                drawPlayerLocation();
                updatedb(input);
            }
            else if (input == "west" || input == "w") {
                x = clamp(x-1, 1, 6);
                document.getElementById("X").innerHTML = x;
                drawPlayerLocation();
                updatedb(input);
            }
            else {
                document.getElementById('invalidInput').hidden = false;
                setTimeout(function() {
                    document.getElementById('invalidInput').hidden = true;
                }, 1000);
            }
            chatInput.value = "";
        }
    }

    function drawPlayerLocation() {
        clearTo();
        let cellCenter = 60;
        let pointX = (canvas.node.width / 6 ) * x - cellCenter;
        let pointY = (canvas.node.height / 6 ) * y - cellCenter;
        let radius = 15;
        let circlefillColor = '#3f888f';
        fillCircle(pointX, pointY, radius, circlefillColor);
        drawGrid();
    }

    function createCanvas(parent) {
        canvas.node = document.createElement('canvas');
        canvas.context = canvas.node.getContext('2d');
        canvas.node.width = 720;
        canvas.node.height = 720;

        canvas.fillColor = '#1C00ff00';
        parent.appendChild(canvas.node);
    }

    function drawGrid() {
        let w = canvas.node.width;
        let h = canvas.node.height;
        canvas.context.strokeStyle = '#000000';
        canvas.context.lineWidth = 1;

        canvas.context.beginPath();
        for (var gridX = 0; gridX <= w; gridX += 120) {
            canvas.context.moveTo(gridX, 0);
            canvas.context.lineTo(gridX, h);
        }
        canvas.context.stroke();

        canvas.context.beginPath();
        for (var gridY = 0; gridY <= h; gridY += 120) {
            canvas.context.moveTo(0, gridY);
            canvas.context.lineTo(w, gridY);
        }
        canvas.context.stroke();
    }

    function initCanvas(container) {
        createCanvas(container);
        clearTo();
        drawPlayerLocation();
    }

    function fillCircle(x, y, radius, fillColor) {
        canvas.context.fillStyle = fillColor;
        canvas.context.beginPath();
        canvas.context.moveTo(x, y);
        canvas.context.arc(x, y, radius, 0, Math.PI * 2, false);
        canvas.context.fill();
    };

    function clearTo() {
        canvas.context.clearRect(0, 0, canvas.node.width, canvas.node.height);
    };

    function exitGame() {
        console.log("exit");
        player = null || sessionStorage.getItem("player")
        if (player !== null) {
        var url = new URL(window.location.origin + '/exitgame');
        console.log("exit2");
        fetch(url, 
            {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: "PUT"
            })
            console.log("exit3");
        }
    };

    function wonGame() {
        console.log("won");
        player = null || sessionStorage.getItem("player")
        if (player !== null) {
        var url = new URL(window.location.origin + '/wongame');
        console.log("won2");
        fetch(url, 
            {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: "PUT"
            })
        }
    }

    function updatedb(input) {
        console.log(input)
        player = null || sessionStorage.getItem("player")
        if (player !== null) {
            if (input == "north" || input == "n") {
                let url = new URL(window.location.origin + '/direction/north');
                fetch(url, 
                    {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    method: "PUT",
                    body: JSON.stringify({x: x, y: y})
                    })
            } else if (input == "south" || input == "s") {
                let url = new URL(window.location.origin + '/direction/south');
                fetch(url, 
                    {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    method: "PUT",
                    body: JSON.stringify({x: x, y: y})
                    })
            } else if (input == "east" || input == "e") {
                let url = new URL(window.location.origin + '/direction/east');
                fetch(url, 
                    {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    method: "PUT",
                    body: JSON.stringify({x: x, y: y})
                    })
            } else if (input == "west" || input == "w") {
                let url = new URL(window.location.origin + '/direction/west');
                fetch(url, 
                    {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    method: "PUT",
                    body: JSON.stringify({x: x, y: y})
                    })
            }
        }
    }


</script>
<script src="cellDetails.js"></script>

</body>
</html>
